<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Monitoring Kafka Connector with Kubernetes | Bitrock</title>
    <meta name="description" content="In order to successfully develop and apply innovative technology you need to be able to look beyond the horizon, anticipating trends and recognizing the next standards.">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" href="/logotype.png">
  <link rel="manifest" href="/app.webmanifest">
  <meta name="theme-color" content="#2a2a2a">
  <meta name="author" content="Bitrock">
  <meta name="title" property="og:title" content="Bitrock">
  <meta name="og:description" content="In order to successfully develop and apply innovative technology you need to be able to look beyond the horizon, anticipating trends and recognizing the next standards.">
  <meta name="image" property="og:image" content="/social.png">
    
    <link rel="preload" href="/assets/css/0.styles.b17daab2.css" as="style"><link rel="preload" href="/assets/js/app.3017864d.js" as="script"><link rel="preload" href="/assets/js/5.16fe373e.js" as="script"><link rel="preload" href="/assets/js/33.fdb02fca.js" as="script"><link rel="preload" href="/assets/js/9.91369f7b.js" as="script"><link rel="prefetch" href="/assets/js/10.1eded6dc.js"><link rel="prefetch" href="/assets/js/11.c912d9a0.js"><link rel="prefetch" href="/assets/js/12.09d69e0b.js"><link rel="prefetch" href="/assets/js/13.1e8463b0.js"><link rel="prefetch" href="/assets/js/14.66b2bd83.js"><link rel="prefetch" href="/assets/js/15.d6ff773e.js"><link rel="prefetch" href="/assets/js/16.09c65213.js"><link rel="prefetch" href="/assets/js/17.a453b3da.js"><link rel="prefetch" href="/assets/js/18.95c4d29c.js"><link rel="prefetch" href="/assets/js/19.71b94f5a.js"><link rel="prefetch" href="/assets/js/2.fb815d92.js"><link rel="prefetch" href="/assets/js/20.1735d7b0.js"><link rel="prefetch" href="/assets/js/21.d59e25a1.js"><link rel="prefetch" href="/assets/js/22.c92c7f3f.js"><link rel="prefetch" href="/assets/js/23.2103b8ae.js"><link rel="prefetch" href="/assets/js/24.4cdb4123.js"><link rel="prefetch" href="/assets/js/25.97fab8d0.js"><link rel="prefetch" href="/assets/js/26.2a00d6f4.js"><link rel="prefetch" href="/assets/js/27.6ecd8c56.js"><link rel="prefetch" href="/assets/js/28.23799554.js"><link rel="prefetch" href="/assets/js/29.36bc4ada.js"><link rel="prefetch" href="/assets/js/3.44cb95ca.js"><link rel="prefetch" href="/assets/js/30.a592d5eb.js"><link rel="prefetch" href="/assets/js/31.787c1528.js"><link rel="prefetch" href="/assets/js/32.dc59d5f2.js"><link rel="prefetch" href="/assets/js/34.9e7b6544.js"><link rel="prefetch" href="/assets/js/35.bd6e0931.js"><link rel="prefetch" href="/assets/js/36.7a6f7793.js"><link rel="prefetch" href="/assets/js/37.69944610.js"><link rel="prefetch" href="/assets/js/38.2ea7963c.js"><link rel="prefetch" href="/assets/js/39.69019461.js"><link rel="prefetch" href="/assets/js/4.187cc577.js"><link rel="prefetch" href="/assets/js/40.2a8f1716.js"><link rel="prefetch" href="/assets/js/41.6de9d84a.js"><link rel="prefetch" href="/assets/js/42.263f557c.js"><link rel="prefetch" href="/assets/js/43.803b33e9.js"><link rel="prefetch" href="/assets/js/6.94a49d88.js"><link rel="prefetch" href="/assets/js/7.f5d1f2d5.js"><link rel="prefetch" href="/assets/js/8.a6fd5871.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b17daab2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="cover"><header class="main active"><div class="wrapper"><div class="logo"><a href="/" aria-label="Bitrock logo" class="router-link-active"><!----></a></div> <nav><ul><li><a href="/discover" aria-label="About" class="text-">About
          </a></li><li><a href="/academy" aria-label="Academy" class="text-">Academy
          </a></li><li><a href="https://www.linkedin.com/company/bitrock-srl/jobs/" rel="noopener" target="_blank" aria-label="Join Us" class="text-">Join Us</a></li><li><a href="/blog" aria-label="Blog" class="router-link-active text-">Blog
          </a></li></ul></nav> <button type="button" aria-label="mobile-menu" class="hamburger hamburger--spin"><span class="hamburger-box"><span class="hamburger-inner"></span></span></button></div></header> <main class="content wrapper"><article class="card"><div class="category">TECHNOLOGY</div> <section><div class="body"><h3>Monitoring Kafka Connector with Kubernetes</h3> <div class="content__default"><br> <h2 id="the-problem"><a href="#the-problem" aria-hidden="true" class="header-anchor">#</a> <strong>The Problem</strong></h2> <p>The popularity of microservice architecture has enormously increased recently; but this comes with new challenges.</p> <p>One of these is monitoring. In one of our projects, we used a Kafka connector to intercept changes in our database and write data to a topic. This was a very important component of the system, so we needed to consider its health status carefully.</p> <br> <h2 id="solution"><a href="#solution" aria-hidden="true" class="header-anchor">#</a> <strong>Solution</strong></h2> <p>In our first version, we created a Kubernetes’ CronnJob with a simple shell script that checks the status of the connector and, eventually, deletes the failed and restarts it.</p> <p>This worked quite well; however, this is different from how the other services are health checked with the Kubernetes.</p> <p>The connector was deployed with Kubernetes; the most natural thing to do is thus using k8s for monitoring pods and eventually restarting it.</p> <p>The Kafka Connect framework comes with Rest API, and one of these gives you the state of the connectors:</p> <p>i.e : <a href="http://localhost:8083/connectors/connector_name/tasks/taskid/status" target="_blank" rel="noopener noreferrer">http://localhost:8083/connectors/connector_name/tasks/taskid/status<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>This seems to resolve our problem... But is it really the case?</p> <p>Kubernetes health check controls the HTTP status code; the problem is that the Kafka connector API returns 200 HTTP status.</p> <p>For instance, if the task is failed, the API will return:</p> <p>HTTP/1.1 200 OK</p> <p>{&quot;state&quot;:&quot;FAILED&quot;,&quot;id&quot;:1,&quot;worker_id&quot;:&quot;192.168.86.101:8083&quot;}</p> <p>In this case, from the Kubernetes point of view, everything is ok.</p> <p>The solution that worked well for us consisted in adding a sidecar container that takes responsibility for exposing the state of the connector task.</p> <p>The sidecar pattern allows you to extract some functionalities of your application in a different component. For example, we can separate the authentication layer from our “main” component that contains the business logic or - as in our case - extracts the monitoring part.</p> <p>Our goal is to obtain something like this:</p> <p><img src="/img/s-1.png" alt=""></p> <p>First of all, we created a simple application that takes care of calling the connector API and exposes an API for Kubernetes (we used a simple Python application using Flask - but you can use whatever you want). Something like this:</p> <p><img src="/img/s-2.png" alt=""></p> <p>As you can see, the code is very simple.</p> <p>The application does two different things: first of all, it exposes an endpoint at “/health” paths that will be called periodically by Kubernetes; secondly, it checks the status of a task and eventually returns an Internal Server Error, in case the HTTP status of the connector was not 200 or if the status was not “RUNNING”.</p> <p>Now, this application needs to be deployed in the same pods of the connector. This can be done by adding to our deployment.yaml file the container that contains our Python application:</p> <p><img src="/img/s-3.png" alt=""></p> <br> <h2 id="conclusions"><a href="#conclusions" aria-hidden="true" class="header-anchor">#</a> <strong>Conclusions</strong></h2> <p>The logical result?</p> <p>Both containers expose the health check of the sidecar, since Kubernetes does not restart the entire pods if one container is up; exposing the same API, the destiny of both containers would be the same.</p> <p>Once the connector is in FAILED state, Kubernetes will restart the pod.</p> <p>Some cloud providers may provide a built-in solution for problems like this; but if you can’t use it - for whatever reason - this can be a possible solution.</p> <br> <p><em>Author: Marco Tosini, Principal Engineer @Bitrock</em></p></div></div></section></article></main> <footer id="corporate" class="corporate"><div class="wrapper"><article><div><h4>Corporate</h4> <p><a href="https://www.linkedin.com/company/bitrock-srl/jobs/" target="_blank" rel="noopener">Careers</a> <br> <a href="https://databiz.it/#philosophy" target="_blank" rel="noopener">Group philosophy</a> <br> <a href="https://www.iubenda.com/privacy-policy/81384922" target="_blank" rel="noopener">Privacy policy</a></p></div> <div><h4>Treviso</h4> <p>
           Office and Operational HQ<br> 
           Viale della Repubblica 156/a<br> 
           31100 Treviso (TV)<br>
           Tel: 0422 1600025<br> <a href="mailto:info@bitrock.it">info@bitrock.it</a></p></div> <div><h4>Milano</h4> <p>
          Operational HQ<br>
          Via Borsieri 41<br> 
          20159 Milano (MI)<br>
          Tel: 0422 1600025<br> <a href="mailto:info@bitrock.it">info@bitrock.it</a></p></div> <div><h4>Lugano</h4> <p>
          BITROCK SAGL,<br>
          Via Giacometti 1<br> 
          6900 Lugano <br> <a href="mailto:info@bitrock.it">info@bitrock.it</a></p></div> <div><h4>Follow us</h4> <p><a href="https://www.linkedin.com/company/bitrock-srl/" target="_blank" rel="noopener">Linkedin</a><br> <a href="https://twitter.com/DATABIZit" target="_blank" rel="noopener">Twitter</a></p></div></article></div></footer> <footer class="credits"><div class="wrapper"><article><p><b>Bitrock</b> ©Copyright <span class="year">2020</span>. All rights reserved. P.IVA 10150530961</p></article></div></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.3017864d.js" defer></script><script src="/assets/js/5.16fe373e.js" defer></script><script src="/assets/js/33.fdb02fca.js" defer></script><script src="/assets/js/9.91369f7b.js" defer></script>
  </body>
</html>
