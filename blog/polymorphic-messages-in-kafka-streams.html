<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Polymorphic Messages in Kafka Streams | Bitrock</title>
    <meta name="description" content="In order to successfully develop and apply innovative technology you need to be able to look beyond the horizon, anticipating trends and recognizing the next standards.">
    <meta name="generator" content="VuePress 1.4.0">
    <link rel="icon" href="/logotype.png">
  <link rel="manifest" href="/app.webmanifest">
  <meta name="theme-color" content="#2a2a2a">
  <meta name="author" content="Bitrock">
  <meta name="title" property="og:title" content="Bitrock">
  <meta name="og:description" content="In order to successfully develop and apply innovative technology you need to be able to look beyond the horizon, anticipating trends and recognizing the next standards.">
  <meta name="image" property="og:image" content="/social.png">
    
    <link rel="preload" href="/assets/css/0.styles.b17daab2.css" as="style"><link rel="preload" href="/assets/js/app.5637cc8f.js" as="script"><link rel="preload" href="/assets/js/5.16fe373e.js" as="script"><link rel="preload" href="/assets/js/34.9e7b6544.js" as="script"><link rel="preload" href="/assets/js/9.91369f7b.js" as="script"><link rel="prefetch" href="/assets/js/10.1eded6dc.js"><link rel="prefetch" href="/assets/js/11.c912d9a0.js"><link rel="prefetch" href="/assets/js/12.09d69e0b.js"><link rel="prefetch" href="/assets/js/13.1e8463b0.js"><link rel="prefetch" href="/assets/js/14.66b2bd83.js"><link rel="prefetch" href="/assets/js/15.d6ff773e.js"><link rel="prefetch" href="/assets/js/16.09c65213.js"><link rel="prefetch" href="/assets/js/17.a453b3da.js"><link rel="prefetch" href="/assets/js/18.95c4d29c.js"><link rel="prefetch" href="/assets/js/19.71b94f5a.js"><link rel="prefetch" href="/assets/js/2.fb815d92.js"><link rel="prefetch" href="/assets/js/20.1735d7b0.js"><link rel="prefetch" href="/assets/js/21.d59e25a1.js"><link rel="prefetch" href="/assets/js/22.c92c7f3f.js"><link rel="prefetch" href="/assets/js/23.2103b8ae.js"><link rel="prefetch" href="/assets/js/24.4cdb4123.js"><link rel="prefetch" href="/assets/js/25.97fab8d0.js"><link rel="prefetch" href="/assets/js/26.2a00d6f4.js"><link rel="prefetch" href="/assets/js/27.6ecd8c56.js"><link rel="prefetch" href="/assets/js/28.23799554.js"><link rel="prefetch" href="/assets/js/29.36bc4ada.js"><link rel="prefetch" href="/assets/js/3.44cb95ca.js"><link rel="prefetch" href="/assets/js/30.be09c0f7.js"><link rel="prefetch" href="/assets/js/31.787c1528.js"><link rel="prefetch" href="/assets/js/32.dc59d5f2.js"><link rel="prefetch" href="/assets/js/33.fdb02fca.js"><link rel="prefetch" href="/assets/js/35.bd6e0931.js"><link rel="prefetch" href="/assets/js/36.7a6f7793.js"><link rel="prefetch" href="/assets/js/37.69944610.js"><link rel="prefetch" href="/assets/js/38.2ea7963c.js"><link rel="prefetch" href="/assets/js/39.69019461.js"><link rel="prefetch" href="/assets/js/4.187cc577.js"><link rel="prefetch" href="/assets/js/40.2a8f1716.js"><link rel="prefetch" href="/assets/js/41.6de9d84a.js"><link rel="prefetch" href="/assets/js/42.263f557c.js"><link rel="prefetch" href="/assets/js/43.803b33e9.js"><link rel="prefetch" href="/assets/js/6.94a49d88.js"><link rel="prefetch" href="/assets/js/7.f5d1f2d5.js"><link rel="prefetch" href="/assets/js/8.a6fd5871.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b17daab2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="cover"><header class="main active"><div class="wrapper"><div class="logo"><a href="/" aria-label="Bitrock logo" class="router-link-active"><!----></a></div> <nav><ul><li><a href="/discover" aria-label="About" class="text-">About
          </a></li><li><a href="/academy" aria-label="Academy" class="text-">Academy
          </a></li><li><a href="https://www.linkedin.com/company/bitrock-srl/jobs/" rel="noopener" target="_blank" aria-label="Join Us" class="text-">Join Us</a></li><li><a href="/blog" aria-label="Blog" class="router-link-active text-">Blog
          </a></li></ul></nav> <button type="button" aria-label="mobile-menu" class="hamburger hamburger--spin"><span class="hamburger-box"><span class="hamburger-inner"></span></span></button></div></header> <main class="content wrapper"><article class="card"><div class="category">TECHNOLOGY</div> <section><div class="body"><h3>Polymorphic Messages in Kafka Streams</h3> <div class="content__default"><h3 id="things-usually-start-simple"><a href="#things-usually-start-simple" aria-hidden="true" class="header-anchor">#</a> Things usually start simple...</h3> <p>You are designing a Kafka Streams application which must read commands and produce the corresponding business event. <br>The Avro models you’re expecting to read look like this:</p> <p><img src="/img/1-3.png" alt=""></p> <p>While the output messages you’re required to produce look like this:</p> <p><img src="/img/2-1.png" alt=""></p> <p>You know you can leverage the <strong>sbt-avrohugger</strong> plugin to generate the corresponding Scala class for each Avro schema, so that you can focus only on designing the business logic.</p> <p><img src="/img/3-1.png" alt=""></p> <p>Since the messages themselves are pretty straightforward, you decide to create a <strong>monomorphic function</strong> to map properties between each command and the corresponding event. <br>The resulting topology ends up looking like this:</p> <p><img src="/img/4-1.png" alt=""></p> <br> <h3 id="but-then-the-domain-widens"><a href="#but-then-the-domain-widens" aria-hidden="true" class="header-anchor">#</a> ...But then the domain widens</h3> <p>Today new functional requirements have emerged: your application must now handle <strong>multiple types</strong> of assets, each with its own unique properties. <br> You are pondering how to implement this requirement and make your application more resilient to further changes in behavior.</p> <h2 id="multiple-streams"><a href="#multiple-streams" aria-hidden="true" class="header-anchor">#</a> Multiple streams</h2> <p>You could split both commands and events into <strong>multiple topics</strong>, one per asset type, so that the corresponding Avro schema stays consistent and its compatibility is ensured. <br>This solution, however, would have you replicate pretty much the same topology multiple times, so it’s not recommended unless the business logic has to be customized for each asset type.</p> <h2 id="all-and-none-messages"><a href="#all-and-none-messages" aria-hidden="true" class="header-anchor">#</a> “All-and-none” messages</h2> <p>Avro doesn’t support inheritance between records, so any OOP strategy to have assets inherit properties from a common ancestor is unfortunately not viable. <br>You could however create a “Frankenstein” object with <strong>all the properties</strong> of each and every asset and fill in only those required for each type of asset. <br>This is definitely the worst solution from an evolutionary and maintainability point of view.</p> <h2 id="union-types"><a href="#union-types" aria-hidden="true" class="header-anchor">#</a> Union types</h2> <p>Luckily for you, Avro offers an interesting feature named <strong>union types</strong>: you could express the diversity in each asset’s properties via a union of multiple payloads, still relying on one single message as wrapper.</p> <p><img src="/img/5-1.png" alt=""></p> <p><img src="/img/6-1.png" alt=""></p> <br> <h3 id="enter-polymorphic-streams"><a href="#enter-polymorphic-streams" aria-hidden="true" class="header-anchor">#</a> Enter polymorphic streams</h3> <h2 id="objects-with-no-shape"><a href="#objects-with-no-shape" aria-hidden="true" class="header-anchor">#</a> Objects with no shape</h2> <p>To cope with this advanced polymorphism, you leverage the <a href="https://github.com/milessabin/shapeless" target="_blank" rel="noopener noreferrer"><strong>shapeless</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> library, which introduces the Coproduct type, the perfect companion for the Avro union type. <br>First of all, you update the custom types mapping of sbt-avrohugger, so that it generates an additional <strong>sealed trait</strong> for each Avro protocol containing multiple records:</p> <p><img src="/img/7.png" alt=""></p> <p>The generated command class ends up looking like this:</p> <p><img src="/img/8.png" alt=""></p> <h2 id="updating-the-business-logic"><a href="#updating-the-business-logic" aria-hidden="true" class="header-anchor">#</a> Updating the business logic</h2> <p>Thanks to shapeless’ <strong>Poly1</strong> trait you then write the updated business logic in a single class:</p> <p><img src="/img/9.png" alt=""></p> <p>Changes to the topology are minimal, as you’d expect:</p> <p><img src="/img/10.png" alt=""></p> <h2 id="a-special-kind-of-serde"><a href="#a-special-kind-of-serde" aria-hidden="true" class="header-anchor">#</a> A special kind of Serde</h2> <p>Now for the final piece of the puzzle, Serdes. Introducing the <a href="https://github.com/sksamuel/avro4s" target="_blank" rel="noopener noreferrer"><strong>avro4s</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> library, which takes Avro GenericRecords above and beyond. <br>You create a <strong>type class</strong> to extend a plain old Serde providing a brand new method:</p> <p><img src="/img/11.png" alt=""></p> <p>Now each generated class has its own Serde, tailored on the corresponding Avro schema.</p> <h2 id="putting-everything-together"><a href="#putting-everything-together" aria-hidden="true" class="header-anchor">#</a> Putting everything together</h2> <p>Finally, the main program where you combine all ingredients:</p> <p><img src="/img/12.png" alt=""></p> <br> <br> <h3 id="conclusions"><a href="#conclusions" aria-hidden="true" class="header-anchor">#</a> Conclusions</h3> <p>When multiple use cases share (almost) the same business logic, you can create a stream processing application with <strong>ad-hoc polymorphism</strong> and reduce the duplication of code to the minimum, while making your application even more future-proof.</p></div></div></section></article></main> <footer id="corporate" class="corporate"><div class="wrapper"><article><div><h4>Corporate</h4> <p><a href="https://www.linkedin.com/company/bitrock-srl/jobs/" target="_blank" rel="noopener">Careers</a> <br> <a href="https://databiz.it/#philosophy" target="_blank" rel="noopener">Group philosophy</a> <br> <a href="https://www.iubenda.com/privacy-policy/81384922" target="_blank" rel="noopener">Privacy policy</a></p></div> <div><h4>Treviso</h4> <p>
           Office and Operational HQ<br> 
           Viale della Repubblica 156/a<br> 
           31100 Treviso (TV)<br>
           Tel: 0422 1600025<br> <a href="mailto:info@bitrock.it">info@bitrock.it</a></p></div> <div><h4>Milano</h4> <p>
          Operational HQ<br>
          Via Borsieri 41<br> 
          20159 Milano (MI)<br>
          Tel: 0422 1600025<br> <a href="mailto:info@bitrock.it">info@bitrock.it</a></p></div> <div><h4>Lugano</h4> <p>
          BITROCK SAGL,<br>
          Via Giacometti 1<br> 
          6900 Lugano <br> <a href="mailto:info@bitrock.it">info@bitrock.it</a></p></div> <div><h4>Follow us</h4> <p><a href="https://www.linkedin.com/company/bitrock-srl/" target="_blank" rel="noopener">Linkedin</a><br> <a href="https://twitter.com/DATABIZit" target="_blank" rel="noopener">Twitter</a></p></div></article></div></footer> <footer class="credits"><div class="wrapper"><article><p><b>Bitrock</b> ©Copyright <span class="year">2020</span>. All rights reserved. P.IVA 10150530961</p></article></div></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.5637cc8f.js" defer></script><script src="/assets/js/5.16fe373e.js" defer></script><script src="/assets/js/34.9e7b6544.js" defer></script><script src="/assets/js/9.91369f7b.js" defer></script>
  </body>
</html>
